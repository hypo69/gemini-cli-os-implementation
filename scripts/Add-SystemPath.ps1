#requires -Version 5.1
#requires -RunAsAdministrator

# =================================================================================
# Add-SystemPath.ps1 — Добавление директории в СИСТЕМНЫЙ PATH для ВСЕХ ПОЛЬЗОВАТЕЛЕЙ
# PowerShell >= 5.1
# Требует запуска от имени Администратора!
# Автор: hypo69
# Версия: 1.2 (интерактивный ввод)
# Дата создания: 07/08/2025
# =================================================================================

# =================================================================================
# ЛИЦЕНЗИЯ (MIT) - без изменений
# =================================================================================
<#
.SYNOPSIS
    Добавляет указанную директорию в СИСТЕМНУЮ переменную среды PATH.

.DESCRIPTION
    Скрипт в интерактивном режиме запрашивает путь к директории и безопасно добавляет его
    в системную переменную PATH (для всех пользователей). Требует прав Администратора.
    Проверяет существование директории и создает ее при необходимости. 
    Затем проверяет наличие пути в PATH, чтобы избежать дублирования.

.EXAMPLE
    PS C:\> .\Add-SystemPath.ps1
    (Скрипт запросит путь для добавления)

.NOTES
    Автор: hypo69
    Изменения требуют перезапуска консоли для вступления в силу в новых сессиях.
#>

# --- НАЧАЛО: Интерактивный запрос и проверка пути ---

# Запрашиваем у пользователя путь. Результат сохранится в переменную $Path
$Path = Read-Host "Введите полный путь к папке для добавления в системный PATH (например, C:\Tools)"

# Проверяем, ввел ли пользователь хоть что-нибудь
if ([string]::IsNullOrWhiteSpace($Path)) {
    Write-Warning "Путь не может быть пустым. Операция отменена."
    # Даем пользователю время прочитать сообщение перед выходом
    Read-Host "Нажмите Enter для выхода..."
    # Прерываем выполнение скрипта
    return
}

Write-Verbose "Начало выполнения скрипта для добавления '$Path' в системный PATH."

# --- КОНЕЦ: Интерактивный запрос и проверка пути ---


# --- ОСНОВНАЯ ЛОГИКА (осталась без изменений) ---

# 1. Проверяем и создаем папку, если необходимо
if (-not (Test-Path -Path $Path)) {
    Write-Host "Папка '$Path' не найдена. Создаю ее..." -ForegroundColor Yellow
    # Создаем папку. Out-Null скрывает вывод команды New-Item.
    New-Item -Path $Path -ItemType Directory -Force | Out-Null
    Write-Host "✅ Папка '$Path' успешно создана." -ForegroundColor Green
}

# 2. Получаем СИСТЕМНЫЙ PATH
$scope = [System.EnvironmentVariableTarget]::Machine
$currentPath = [System.Environment]::GetEnvironmentVariable('Path', $scope)

# 3. Проверяем наличие пути в PATH
$pathEntries = $currentPath -split ';' -ne ''
if ($pathEntries -contains $Path) {
    Write-Host "✅ Путь '$Path' уже находится в системной переменной PATH." -ForegroundColor Green
} else {
    # 4. Добавляем новый путь
    $newPath = "$currentPath;$Path"
    [System.Environment]::SetEnvironmentVariable('Path', $newPath, $scope)
    Write-Host "✅ Путь '$Path' успешно добавлен в СИСТЕМНУЮ переменную PATH." -ForegroundColor Green
    
    # Обновляем PATH для текущей сессии
    $env:Path += ";$Path"
    Write-Host "   Изменения применены для текущей сессии. Перезапустите консоль для постоянного эффекта."
}

Write-Verbose "Выполнение скрипта завершено."
Read-Host "Нажмите Enter для завершения."